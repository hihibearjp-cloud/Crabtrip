<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>é—œè¥¿èƒèŸ¹</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- SheetJS for Excel Export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <!-- iOS Standalone Mode Settings -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="é—œè¥¿èƒèŸ¹">
  <meta name="theme-color" content="#FF6B6B">
  <meta name="mobile-web-app-capable" content="yes">

  <!-- PWA Manifest (inline as data URI) -->
  <link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22%E9%97%9C%E8%A5%BF%E8%9E%83%E8%9F%B9%E6%A9%AB%E8%91%97%E8%B5%B0%22%2C%22short_name%22%3A%22%E9%97%9C%E8%A5%BF%E8%9E%83%E8%9F%B9%22%2C%22description%22%3A%222026%E5%B9%B4%E6%97%A5%E6%9C%AC%E9%97%9C%E8%A5%BF%E6%97%85%E9%81%8A%E8%A8%98%E5%B8%B3App%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23E0F7FA%22%2C%22theme_color%22%3A%22%23FF6B6B%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%2520viewBox%3D%270%25200%2520192%2520192%27%253E%253Crect%2520width%3D%27192%27%2520height%3D%27192%27%2520fill%3D%27%2523FF6B6B%27%2520rx%3D%2748%27%2F%253E%253Ctext%2520x%3D%2796%27%2520y%3D%2796%27%2520font-size%3D%27100%27%2520text-anchor%3D%27middle%27%2520dy%3D%27.35em%27%253E%25F0%259F%25A6%2580%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%2C%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%2520viewBox%3D%270%25200%2520512%2520512%27%253E%253Crect%2520width%3D%27512%27%2520height%3D%27512%27%2520fill%3D%27%2523FF6B6B%27%2520rx%3D%27128%27%2F%253E%253Ctext%2520x%3D%27256%27%2520y%3D%27256%27%2520font-size%3D%27280%27%2520text-anchor%3D%27middle%27%2520dy%3D%27.35em%27%253E%25F0%259F%25A6%2580%253C%2Ftext%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D">

  <!-- App Icons -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23FF6B6B' rx='40'/%3E%3Ctext x='90' y='90' font-size='100' text-anchor='middle' dy='.35em'%3EğŸ¦€%3C/text%3E%3C/svg%3E">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23FF6B6B' rx='25'/%3E%3Ctext x='50' y='50' font-size='60' text-anchor='middle' dy='.35em'%3EğŸ¦€%3C/text%3E%3C/svg%3E">

  <!-- Splash Screen for iOS -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&family=Hi+Melody&display=swap');
    
    body {
      font-family: 'Gaegu', cursive;
      background-color: #E0F7FA;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
      user-select: none;
    }
    
    .safe-area-top {
      padding-top: env(safe-area-inset-top);
      background-color: #FF6B6B;
    }
    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom);
      background-color: white;
    }

    .korean-3d-btn {
      transition: all 0.1s;
      box-shadow: 0px 4px 0px 0px rgba(0,0,0,0.15), 0px 6px 10px rgba(0,0,0,0.05);
      transform: translateY(0);
      position: relative;
    }
    
    .korean-3d-btn:active {
      transform: translateY(4px);
      box-shadow: 0px 0px 0px 0px rgba(0,0,0,0.15);
    }

    .paper-texture {
      background-color: #fffbf0;
      background-image: radial-gradient(#d4c5a6 0.5px, transparent 0.5px);
      background-size: 10px 10px;
    }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    .fade-in { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    
    .slide-in { animation: slideIn 0.35s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    
    .slide-up { animation: slideUp 0.35s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }

    input, select, textarea {
      font-size: 16px !important;
      user-select: text;
    }
    
    /* æ—¥æœŸæ¨™ç±¤æ¨£å¼ */
    .date-pill {
      background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%);
      box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
    }
    
    /* åˆ†é¡æ¨™ç±¤ */
    .category-tag {
      transition: all 0.2s;
    }
    .category-tag:hover {
      transform: scale(1.05);
    }
    
    /* è³¼ç‰©æ¸…å–®å‹¾é¸å‹•ç•« */
    .check-bounce {
      animation: checkBounce 0.3s ease-out;
    }
    @keyframes checkBounce {
      0% { transform: scale(0); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    
    /* Modal èƒŒæ™¯ */
    .modal-backdrop {
      backdrop-filter: blur(4px);
      background: rgba(0, 0, 0, 0.5);
    }
    
    /* é€²åº¦æ¢ */
    .progress-bar {
      transition: width 0.5s ease-out;
    }
  </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-[#E0F7FA]">
  <div id="root" class="h-full w-full"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- Icons ---
    const Icon = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
    );
    const Icons = {
      Plus: (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
      Trash2: (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>,
      Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>,
      Train: (p) => <Icon {...p}><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h0"/><path d="M16 15h0"/></Icon>,
      ShoppingBag: (p) => <Icon {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></Icon>,
      Map: (p) => <Icon {...p}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></Icon>,
      Home: (p) => <Icon {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>,
      Coins: (p) => <Icon {...p}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></Icon>,
      ChevronDown: (p) => <Icon {...p}><path d="m6 9 6 6 6-6"/></Icon>,
      ChevronUp: (p) => <Icon {...p}><path d="m18 15-6-6-6 6"/></Icon>,
      ChevronLeft: (p) => <Icon {...p}><path d="m15 18-6-6 6-6"/></Icon>,
      ChevronRight: (p) => <Icon {...p}><path d="m9 18 6-6-6-6"/></Icon>,
      Calendar: (p) => <Icon {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>,
      Clock: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>,
      Edit: (p) => <Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>,
      Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>,
      X: (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
      FileSpreadsheet: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></Icon>,
      Camera: (p) => <Icon {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></Icon>,
      Star: (p) => <Icon {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></Icon>,
      MapPin: (p) => <Icon {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></Icon>,
      Coffee: (p) => <Icon {...p}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></Icon>,
      Utensils: (p) => <Icon {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></Icon>,
    };

    // --- Data ---
    const INITIAL_ITINERARY = [
      { id: 1, date: '2/2', weekday: 'æ—¥', content: 'å¤§é˜ª â†’ 17:00åé–€å¤§æ´‹æ¸¡è¼ª (å‰å¾€é–€å¸æ¸¯)', transport: 'åé–€å¤§æ´‹æ¸¡è¼ª', stay: 'èˆ¹ä¸Šä½å®¿', cost: 15000, costNote: 'ä½å®¿è²»', notes: '', highlights: ['æ¸¡è¼ªåˆé«”é©—', 'æ¬£è³ç€¨æˆ¶å…§æµ·å¤œæ™¯'], meals: { breakfast: '', lunch: '', dinner: 'èˆ¹ä¸Šé¤å»³' } },
      { id: 2, date: '2/3', weekday: 'ä¸€', content: 'æŠµé”é–€å¸æ¸¯ â†’ é–€å¸æ¸¯æ‡·èˆŠå€ â†’ å°å€‰åŸ â†’ ç¦å²¡åšå¤š', transport: 'JRä¹å· (ç¦å²¡å»£åŸŸ) 1', stay: 'ç¦å²¡ Quintessa hotel', cost: 3500, costNote: 'äº¤é€šè²»', notes: '', highlights: ['é–€å¸æ¸¯æ‡·èˆŠå»ºç¯‰', 'ç‡’å’–å“©'], meals: { breakfast: 'èˆ¹ä¸Š', lunch: 'é–€å¸æ¸¯ç‡’å’–å“©', dinner: 'åšå¤šæ‹‰éºµ' } },
      { id: 3, date: '2/4', weekday: 'äºŒ', content: 'å¤ªå®°åºœã€æŸ³å· â†’ æ«›ç”°ç¥ç¤¾ â†’ å·ç«¯é€šå•†åº—è¡— â†’ åšå¤šé‹æ²³åŸ', transport: 'JRä¹å· (ç¦å²¡å»£åŸŸ) 2', stay: 'ç¦å²¡ Quintessa hotel', cost: 0, costNote: '', notes: '', highlights: ['å¤ªå®°åºœå¤©æ»¿å®®', 'æŸ³å·éŠèˆ¹'], meals: { breakfast: 'é£¯åº—', lunch: 'æŸ³å·é°»é­šé£¯', dinner: '' } },
      { id: 4, date: '2/5', weekday: 'ä¸‰', content: 'ç¦å²¡ â†’ (1 hr) å»£å³¶åš´å³¶ç¥ç¤¾ â†’ å²¡å±±', transport: 'JRè¥¿æ—¥æœ¬å…¨å€Pass 1', stay: 'å²¡å±±æ±æ©«inn', cost: 33315, costNote: 'Pass 26000 + ä½å®¿ 7315', notes: '', highlights: ['åš´å³¶ç¥ç¤¾å¤§é³¥å±…', 'å®®å³¶é¹¿'], meals: { breakfast: 'é£¯åº—', lunch: 'å»£å³¶ç‡’', dinner: 'å²¡å±±' } },
      { id: 5, date: '2/6', weekday: 'å››', content: 'å²¡å±± â†’ å‡ºé›²å¸‚ â†’ å‡ºé›²å¤§ç¤¾ â†’ é³¥å–', transport: 'JRè¥¿æ—¥æœ¬å…¨å€Pass 2', stay: 'é³¥å–æ±æ©«inn', cost: 6745, costNote: 'ä½å®¿è²»', notes: '', highlights: ['å‡ºé›²å¤§ç¤¾çµç·£', 'ç¥è©±ä¹‹åœ‹'], meals: { breakfast: 'é£¯åº—', lunch: 'å‡ºé›²è•éº¥éºµ', dinner: 'é³¥å–' } },
      { id: 6, date: '2/7', weekday: 'äº”', content: 'é³¥å–ç ‚ä¸˜ â†’ (åŸå´æº«æ³‰) â†’ äº¬éƒ½', transport: 'è§€å…‰è¨ˆç¨‹è»Š3å°æ™‚', stay: 'Ala hotel äº¬éƒ½ç«™å‰', cost: 38170, costNote: 'è»Šè³‡4000 + ä½å®¿ 34170', notes: '', highlights: ['é³¥å–ç ‚ä¸˜', 'åŸå´æº«æ³‰è¡—'], meals: { breakfast: 'é£¯åº—', lunch: 'æµ·é®®ä¸¼', dinner: 'äº¬éƒ½' } },
      { id: 7, date: '2/8', weekday: 'å…­', content: 'äº¬éƒ½è§€å…‰ / è§€å…‰ç«è»Š', transport: 'è§€å…‰ç«è»Š', stay: 'Ala hotel äº¬éƒ½ç«™å‰', cost: 0, costNote: 'å¾…ç¢ºèª', notes: 'è¨˜å¾—é ç´„è§€å…‰ç«è»Š', highlights: ['åµå±±å°ç«è»Š', 'ç«¹æ—'], meals: { breakfast: 'é£¯åº—', lunch: '', dinner: '' } },
      { id: 8, date: '2/9', weekday: 'æ—¥', content: 'äº¬éƒ½ â†’ æ•¦è³€ â†’ é‡‘æ¾¤ â†’ äº¬éƒ½', transport: 'JRç‰¹æ€¥é›·é³¥è™Ÿ', stay: 'Ala hotel äº¬éƒ½ç«™å‰', cost: 0, costNote: '', notes: '', highlights: ['é‡‘æ¾¤å…¼å…­åœ’', '21ä¸–ç´€ç¾è¡“é¤¨'], meals: { breakfast: 'é£¯åº—', lunch: 'é‡‘æ¾¤æµ·é®®', dinner: 'äº¬éƒ½' } },
      { id: 9, date: '2/10', weekday: 'ä¸€', content: 'æ¢…ç”°æ­é˜ªæ€¥å·´å£« â†’ å‹å°¾å¯º é”æ‘© â†’ é›£æ³¢Salmon Kat â†’ è‡¨ç©ºåŸOMO', transport: 'JRè¥¿æ—¥æœ¬å…¨å€Pass 7', stay: 'è‡¨ç©ºåŸOMO 7', cost: 0, costNote: '', notes: '', highlights: ['å‹å°¾å¯ºé”æ‘©', 'è‡¨ç©ºåŸOutlet'], meals: { breakfast: 'é£¯åº—', lunch: '', dinner: 'Outletç¾é£Ÿè¡—' } },
      { id: 10, date: '2/11', weekday: 'äºŒ', content: 'è‡¨ç©ºåŸè³¼ç‰© â†’ å‚æ™šè¿”é«˜é›„', transport: 'é•·æ¦®BR 147 20:20', stay: 'è¿”ç¨‹', cost: 0, costNote: '', notes: 'è¨˜å¾—è²·ä¼´æ‰‹ç¦®', highlights: ['æœ€å¾Œè¡åˆºè³¼ç‰©'], meals: { breakfast: 'é£¯åº—', lunch: 'Outlet', dinner: 'æ©Ÿä¸Š' } },
    ];
    
    const INITIAL_SHOPPING = [
      { id: 1, item: 'è—¥å¦ (åˆåˆ©ä»–å‘½)', budget: 5000, bought: false, store: 'æ¾æœ¬æ¸…', priority: 'high' },
      { id: 2, item: 'Uniqlo ç™¼ç†±è¡£', budget: 10000, bought: false, store: 'Uniqlo', priority: 'medium' },
      { id: 3, item: 'æ©Ÿå ´ä¼´æ‰‹ç¦® (ç™½è‰²æˆ€äºº)', budget: 3000, bought: false, store: 'æ©Ÿå ´å…ç¨…åº—', priority: 'high' },
      { id: 4, item: 'Loft æ–‡å…·', budget: 2000, bought: false, store: 'Loft', priority: 'low' },
      { id: 5, item: 'æŠ¹èŒ¶é›¶é£Ÿ', budget: 1500, bought: false, store: 'ä¾¿åˆ©å•†åº—', priority: 'medium' },
    ];
    
    const PAYMENT_METHODS = ['ç¾é‡‘', 'ä¿¡ç”¨å¡(ä¸­ä¿¡)', 'ä¿¡ç”¨å¡(å¯Œé‚¦J)', 'ä¿¡ç”¨å¡(åœ‹æ³°Cube)', 'è¥¿ç“œå¡ (Suica)', 'ICOCA', 'PayPay'];
    const BOOKING_PLATFORMS = ['ç¾å ´æ”¯ä»˜', 'Agoda', 'Booking.com', 'Klook', 'KKday', 'Haft (å®˜ç¶²)', 'Rakuten'];
    const CATEGORIES = ['ğŸœ é£²é£Ÿ', 'ğŸšƒ äº¤é€š', 'ğŸ¨ ä½å®¿', 'ğŸ›ï¸ è³¼ç‰©', 'ğŸ« é–€ç¥¨', 'ğŸ“ å…¶ä»–'];
    const BUTTON_COLORS = ['#FF9F43', '#4ECDC4', '#FF6B6B', '#6C5CE7', '#FFA502', '#2ed573'];
    const PRIORITY_COLORS = { high: '#FF6B6B', medium: '#FF9F43', low: '#4ECDC4' };

    // --- Main App ---
    function App() {
      const loadState = (key, defaultVal) => {
        try {
          const saved = localStorage.getItem(key);
          return saved ? JSON.parse(saved) : defaultVal;
        } catch (e) {
          return defaultVal;
        }
      };

      const [activeTab, setActiveTab] = useState('itinerary');
      const [itinerary, setItinerary] = useState(() => loadState('crab_itinerary_v2', INITIAL_ITINERARY));
      const [expenses, setExpenses] = useState(() => loadState('crab_expenses_v2', []));
      const [shoppingList, setShoppingList] = useState(() => loadState('crab_shopping_v2', INITIAL_SHOPPING));
      const [expandedDayId, setExpandedDayId] = useState(null);
      const [selectedDay, setSelectedDay] = useState(null); // æ¯æ—¥è¡Œç¨‹ç¨ç«‹é é¢
      const [showExpenseModal, setShowExpenseModal] = useState(false);
      const [expenseFilter, setExpenseFilter] = useState('all'); // è¨˜å¸³ç¯©é¸
      const [showExportModal, setShowExportModal] = useState(false);

      // å„²å­˜åˆ° LocalStorage
      useEffect(() => { localStorage.setItem('crab_itinerary_v2', JSON.stringify(itinerary)); }, [itinerary]);
      useEffect(() => { localStorage.setItem('crab_expenses_v2', JSON.stringify(expenses)); }, [expenses]);
      useEffect(() => { localStorage.setItem('crab_shopping_v2', JSON.stringify(shoppingList)); }, [shoppingList]);

      const [newExpense, setNewExpense] = useState({ 
        date: '2/2', item: '', amount: '', currency: 'JPY', 
        category: 'ğŸœ é£²é£Ÿ', method: 'ç¾é‡‘', platform: 'ç¾å ´æ”¯ä»˜', note: '' 
      });
      const [newShopItem, setNewShopItem] = useState({ item: '', budget: '', store: '', priority: 'medium' });

      // è¨˜å¸³åŠŸèƒ½
      const handleAddExpense = () => {
        if (!newExpense.item || !newExpense.amount) return;
        setExpenses([...expenses, { id: Date.now(), ...newExpense, amount: parseFloat(newExpense.amount), timestamp: new Date().toISOString() }]);
        setNewExpense({ ...newExpense, item: '', amount: '', note: '' });
        setShowExpenseModal(false);
      };
      
      const handleDeleteExpense = (id) => {
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
          setExpenses(expenses.filter(e => e.id !== id));
        }
      };
      
      // è³¼ç‰©æ¸…å–®åŠŸèƒ½
      const handleAddShoppingItem = () => {
        if (!newShopItem.item) return;
        setShoppingList([...shoppingList, { 
          id: Date.now(), 
          item: newShopItem.item, 
          budget: parseFloat(newShopItem.budget) || 0, 
          store: newShopItem.store,
          priority: newShopItem.priority,
          bought: false 
        }]);
        setNewShopItem({ item: '', budget: '', store: '', priority: 'medium' });
      };
      
      const toggleShoppingItem = (id) => {
        setShoppingList(shoppingList.map(item => 
          item.id === id ? { ...item, bought: !item.bought } : item
        ));
      };
      
      const deleteShoppingItem = (id) => {
        if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹é …ç›®å—ï¼Ÿ')) {
          setShoppingList(shoppingList.filter(item => item.id !== id));
        }
      };
      
      // è¡Œç¨‹åŠŸèƒ½
      const updateItinerary = (id, field, value) => {
        setItinerary(itinerary.map(item => item.id === id ? { ...item, [field]: value } : item));
      };
      
      const toggleDay = (id) => setExpandedDayId(expandedDayId === id ? null : id);

      // çµ±è¨ˆæ•¸æ“š
      const totalSpentJPY = expenses.filter(e => e.currency === 'JPY').reduce((acc, curr) => acc + curr.amount, 0);
      const totalSpentTWD = expenses.filter(e => e.currency === 'TWD').reduce((acc, curr) => acc + curr.amount, 0);
      const totalBudget = itinerary.reduce((acc, day) => acc + (day.cost || 0), 0);
      const shoppingProgress = shoppingList.length > 0 
        ? Math.round((shoppingList.filter(i => i.bought).length / shoppingList.length) * 100) 
        : 0;

      // ä¾æ—¥æœŸç¯©é¸çš„è¨˜å¸³
      const getExpensesByDate = (date) => expenses.filter(e => e.date === date);
      const filteredExpenses = expenseFilter === 'all' 
        ? expenses 
        : expenses.filter(e => e.date === expenseFilter);

      // åŒ¯å‡º Excel (çœŸæ­£çš„ xlsx)
      const exportToExcel = () => {
        const wb = XLSX.utils.book_new();
        
        // 1. è¡Œç¨‹ç¸½è¦½ Sheet
        const itineraryData = itinerary.map(day => ({
          'æ—¥æœŸ': day.date,
          'æ˜ŸæœŸ': day.weekday || '',
          'è¡Œç¨‹å…§å®¹': day.content,
          'äº¤é€šæ–¹å¼': day.transport,
          'ä½å®¿': day.stay,
          'é ç®—èŠ±è²»': day.cost,
          'å‚™è¨»': day.costNote,
          'äº®é»': (day.highlights || []).join('ã€'),
          'æ—©é¤': day.meals?.breakfast || '',
          'åˆé¤': day.meals?.lunch || '',
          'æ™šé¤': day.meals?.dinner || '',
          'ç­†è¨˜': day.notes || ''
        }));
        const wsItinerary = XLSX.utils.json_to_sheet(itineraryData);
        wsItinerary['!cols'] = [
          {wch: 8}, {wch: 6}, {wch: 40}, {wch: 20}, {wch: 20}, 
          {wch: 10}, {wch: 25}, {wch: 30}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 30}
        ];
        XLSX.utils.book_append_sheet(wb, wsItinerary, 'è¡Œç¨‹ç¸½è¦½');
        
        // 2. æ¯æ—¥è¨˜å¸³ Sheet
        const expenseData = expenses.map(e => ({
          'æ—¥æœŸ': e.date,
          'é …ç›®': e.item,
          'é‡‘é¡': e.amount,
          'å¹£åˆ¥': e.currency,
          'é¡åˆ¥': e.category,
          'æ”¯ä»˜æ–¹å¼': e.method,
          'å¹³å°': e.platform,
          'å‚™è¨»': e.note || '',
          'è¨˜éŒ„æ™‚é–“': e.timestamp ? new Date(e.timestamp).toLocaleString('zh-TW') : ''
        }));
        const wsExpenses = XLSX.utils.json_to_sheet(expenseData);
        wsExpenses['!cols'] = [
          {wch: 8}, {wch: 25}, {wch: 12}, {wch: 8}, {wch: 12}, 
          {wch: 15}, {wch: 12}, {wch: 20}, {wch: 20}
        ];
        XLSX.utils.book_append_sheet(wb, wsExpenses, 'æ¯æ—¥è¨˜å¸³');
        
        // 3. è³¼ç‰©æ¸…å–® Sheet
        const shoppingData = shoppingList.map(s => ({
          'é …ç›®': s.item,
          'é ç®—': s.budget || '',
          'å•†åº—': s.store || '',
          'å„ªå…ˆåº¦': s.priority === 'high' ? 'é«˜' : s.priority === 'medium' ? 'ä¸­' : 'ä½',
          'å·²è³¼è²·': s.bought ? 'âœ“' : ''
        }));
        const wsShopping = XLSX.utils.json_to_sheet(shoppingData);
        wsShopping['!cols'] = [{wch: 25}, {wch: 10}, {wch: 15}, {wch: 10}, {wch: 10}];
        XLSX.utils.book_append_sheet(wb, wsShopping, 'è³¼ç‰©æ¸…å–®');
        
        // 4. èŠ±è²»çµ±è¨ˆ Sheet
        const categoryStats = {};
        CATEGORIES.forEach(cat => { categoryStats[cat] = { JPY: 0, TWD: 0 }; });
        expenses.forEach(e => {
          if (categoryStats[e.category]) {
            categoryStats[e.category][e.currency] += e.amount;
          }
        });
        
        const statsData = [
          { 'é …ç›®': 'æ—¥å¹£ç¸½èŠ±è²»', 'é‡‘é¡': totalSpentJPY, 'å¹£åˆ¥': 'JPY' },
          { 'é …ç›®': 'å°å¹£ç¸½èŠ±è²»', 'é‡‘é¡': totalSpentTWD, 'å¹£åˆ¥': 'TWD' },
          { 'é …ç›®': 'è¡Œç¨‹é ç®—ç¸½è¨ˆ', 'é‡‘é¡': totalBudget, 'å¹£åˆ¥': 'JPY' },
          { 'é …ç›®': '', 'é‡‘é¡': '', 'å¹£åˆ¥': '' },
          { 'é …ç›®': '=== åˆ†é¡çµ±è¨ˆ ===', 'é‡‘é¡': '', 'å¹£åˆ¥': '' },
          ...CATEGORIES.map(cat => ({
            'é …ç›®': cat,
            'é‡‘é¡': categoryStats[cat].JPY,
            'å¹£åˆ¥': 'JPY'
          }))
        ];
        const wsStats = XLSX.utils.json_to_sheet(statsData);
        wsStats['!cols'] = [{wch: 20}, {wch: 15}, {wch: 10}];
        XLSX.utils.book_append_sheet(wb, wsStats, 'èŠ±è²»çµ±è¨ˆ');
        
        // 5. æ¯æ—¥èŠ±è²»æ˜ç´° Sheets
        itinerary.forEach(day => {
          const dayExpenses = getExpensesByDate(day.date);
          if (dayExpenses.length > 0) {
            const dayData = dayExpenses.map(e => ({
              'é …ç›®': e.item,
              'é‡‘é¡': e.amount,
              'å¹£åˆ¥': e.currency,
              'é¡åˆ¥': e.category,
              'æ”¯ä»˜æ–¹å¼': e.method,
              'å‚™è¨»': e.note || ''
            }));
            // åŠ å…¥ç•¶æ—¥ç¸½è¨ˆ
            dayData.push({
              'é …ç›®': 'ã€ç•¶æ—¥ç¸½è¨ˆã€‘',
              'é‡‘é¡': dayExpenses.filter(e => e.currency === 'JPY').reduce((a, b) => a + b.amount, 0),
              'å¹£åˆ¥': 'JPY',
              'é¡åˆ¥': '',
              'æ”¯ä»˜æ–¹å¼': '',
              'å‚™è¨»': ''
            });
            const wsDay = XLSX.utils.json_to_sheet(dayData);
            wsDay['!cols'] = [{wch: 25}, {wch: 12}, {wch: 8}, {wch: 12}, {wch: 15}, {wch: 20}];
            XLSX.utils.book_append_sheet(wb, wsDay, `${day.date} ${day.weekday || ''}`);
          }
        });
        
        // ä¸‹è¼‰æª”æ¡ˆ
        XLSX.writeFile(wb, '2026é—œè¥¿èƒèŸ¹æ©«è‘—èµ°_å®Œæ•´ç´€éŒ„.xlsx');
        setShowExportModal(false);
      };

      // Tab æŒ‰éˆ•
      const TabButton = ({ id, IconComp, label, color }) => (
        <button
          onClick={() => { setActiveTab(id); setSelectedDay(null); }}
          className={`flex-1 flex flex-col items-center justify-center p-2 rounded-2xl mx-1 font-hand font-bold text-lg transition-all duration-200 ${activeTab === id ? 'bg-gray-50 -translate-y-2 shadow-lg' : 'bg-transparent text-gray-400'}`}
          style={{ color: activeTab === id ? color : '#bbb' }}
        >
          <IconComp size={28} />
          <span className="text-xs mt-1">{label}</span>
        </button>
      );

      // æ¯æ—¥è¡Œç¨‹ç¨ç«‹é é¢
      const DayDetailPage = ({ day, onClose }) => {
        const dayExpenses = getExpensesByDate(day.date);
        const dayTotalJPY = dayExpenses.filter(e => e.currency === 'JPY').reduce((a, b) => a + b.amount, 0);
        const dayTotalTWD = dayExpenses.filter(e => e.currency === 'TWD').reduce((a, b) => a + b.amount, 0);
        
        return (
          <div className="fixed inset-0 bg-white z-50 flex flex-col slide-in">
            {/* Header */}
            <div className="bg-gradient-to-r from-[#FF6B6B] to-[#FF8E8E] p-4 pt-12 safe-area-top">
              <button onClick={onClose} className="absolute top-12 left-4 text-white p-2">
                <Icons.ChevronLeft size={28} />
              </button>
              <div className="text-center text-white">
                <div className="text-4xl mb-2">ğŸ¦€</div>
                <div className="text-3xl font-black font-hand">{day.date} ({day.weekday})</div>
                <div className="text-sm opacity-80 mt-1">{day.stay}</div>
              </div>
            </div>
            
            {/* Content */}
            <div className="flex-1 overflow-y-auto p-4 paper-texture">
              {/* è¡Œç¨‹å…§å®¹ */}
              <div className="bg-white rounded-2xl p-4 shadow-lg border-2 border-gray-100 mb-4">
                <h3 className="font-hand font-bold text-lg text-gray-700 mb-2 flex items-center gap-2">
                  <Icons.Map size={20} className="text-[#4ECDC4]" /> ä»Šæ—¥è¡Œç¨‹
                </h3>
                <p className="font-hand text-gray-600 leading-relaxed">{day.content}</p>
                
                {/* äº¤é€š */}
                <div className="mt-3 flex items-center gap-2 bg-blue-50 p-2 rounded-lg">
                  <Icons.Train size={18} className="text-blue-500" />
                  <span className="font-hand text-sm text-blue-700">{day.transport}</span>
                </div>
              </div>
              
              {/* äº®é» */}
              {day.highlights && day.highlights.length > 0 && (
                <div className="bg-white rounded-2xl p-4 shadow-lg border-2 border-gray-100 mb-4">
                  <h3 className="font-hand font-bold text-lg text-gray-700 mb-2 flex items-center gap-2">
                    <Icons.Star size={20} className="text-yellow-500" /> ä»Šæ—¥äº®é»
                  </h3>
                  <div className="flex flex-wrap gap-2">
                    {day.highlights.map((h, i) => (
                      <span key={i} className="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full font-hand text-sm">
                        âœ¨ {h}
                      </span>
                    ))}
                  </div>
                </div>
              )}
              
              {/* é¤é£Ÿ */}
              {day.meals && (
                <div className="bg-white rounded-2xl p-4 shadow-lg border-2 border-gray-100 mb-4">
                  <h3 className="font-hand font-bold text-lg text-gray-700 mb-2 flex items-center gap-2">
                    <Icons.Utensils size={20} className="text-orange-500" /> ä»Šæ—¥é¤é£Ÿ
                  </h3>
                  <div className="space-y-2">
                    {day.meals.breakfast && (
                      <div className="flex items-center gap-2">
                        <span className="text-lg">ğŸŒ…</span>
                        <span className="font-hand text-gray-600">æ—©é¤: {day.meals.breakfast}</span>
                      </div>
                    )}
                    {day.meals.lunch && (
                      <div className="flex items-center gap-2">
                        <span className="text-lg">â˜€ï¸</span>
                        <span className="font-hand text-gray-600">åˆé¤: {day.meals.lunch}</span>
                      </div>
                    )}
                    {day.meals.dinner && (
                      <div className="flex items-center gap-2">
                        <span className="text-lg">ğŸŒ™</span>
                        <span className="font-hand text-gray-600">æ™šé¤: {day.meals.dinner}</span>
                      </div>
                    )}
                  </div>
                </div>
              )}
              
              {/* ç•¶æ—¥èŠ±è²» */}
              <div className="bg-white rounded-2xl p-4 shadow-lg border-2 border-gray-100 mb-4">
                <h3 className="font-hand font-bold text-lg text-gray-700 mb-2 flex items-center gap-2">
                  <Icons.Coins size={20} className="text-[#FF9F43]" /> ç•¶æ—¥èŠ±è²»
                </h3>
                <div className="flex justify-between items-center bg-gradient-to-r from-orange-50 to-yellow-50 p-3 rounded-xl mb-3">
                  <div>
                    <div className="text-2xl font-black font-hand text-[#FF9F43]">Â¥{dayTotalJPY.toLocaleString()}</div>
                    {dayTotalTWD > 0 && <div className="text-lg font-bold font-hand text-[#4ECDC4]">${dayTotalTWD.toLocaleString()}</div>}
                  </div>
                  <div className="text-sm font-hand text-gray-500">
                    {dayExpenses.length} ç­†è¨˜éŒ„
                  </div>
                </div>
                
                {dayExpenses.length > 0 ? (
                  <div className="space-y-2 max-h-48 overflow-y-auto">
                    {dayExpenses.map(expense => (
                      <div key={expense.id} className="flex justify-between items-center bg-gray-50 p-2 rounded-lg">
                        <div>
                          <span className="font-hand font-bold text-gray-700">{expense.item}</span>
                          <span className="ml-2 text-xs text-gray-400">{expense.category}</span>
                        </div>
                        <span className="font-hand font-bold text-[#FF9F43]">
                          {expense.currency === 'JPY' ? 'Â¥' : '$'}{expense.amount.toLocaleString()}
                        </span>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-center text-gray-400 font-hand py-4">é‚„æ²’æœ‰è¨˜å¸³ç´€éŒ„</p>
                )}
                
                {/* å¿«é€Ÿè¨˜å¸³æŒ‰éˆ• */}
                <button 
                  onClick={() => { 
                    setNewExpense({...newExpense, date: day.date}); 
                    setShowExpenseModal(true); 
                  }}
                  className="w-full mt-3 bg-[#FF9F43] text-white font-hand font-bold py-2 rounded-xl korean-3d-btn border-2 border-black flex justify-center items-center gap-2"
                >
                  <Icons.Plus size={18} /> è¨˜ä¸€ç­†
                </button>
              </div>
              
              {/* ç­†è¨˜ */}
              <div className="bg-white rounded-2xl p-4 shadow-lg border-2 border-gray-100 mb-20">
                <h3 className="font-hand font-bold text-lg text-gray-700 mb-2 flex items-center gap-2">
                  <Icons.Edit size={20} className="text-purple-500" /> ç­†è¨˜
                </h3>
                <textarea 
                  value={day.notes || ''} 
                  onChange={(e) => updateItinerary(day.id, 'notes', e.target.value)}
                  placeholder="å¯«ä¸‹ä»Šå¤©çš„å¿ƒæƒ…ã€ç™¼ç¾ã€æˆ–é‡è¦äº‹é …..."
                  className="w-full h-32 bg-gray-50 rounded-xl p-3 font-hand text-gray-600 outline-none border-2 border-dashed border-gray-200 focus:border-purple-300"
                />
              </div>
            </div>
          </div>
        );
      };

      // å¿«é€Ÿè¨˜å¸³ Modal
      const ExpenseModal = () => (
        <div className="fixed inset-0 z-50 flex items-end justify-center modal-backdrop" onClick={() => setShowExpenseModal(false)}>
          <div className="bg-white w-full max-w-md rounded-t-3xl p-5 slide-up" onClick={e => e.stopPropagation()}>
            <div className="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
            <h3 className="font-hand font-bold text-xl text-gray-800 mb-4 text-center">ğŸ’° å¿«é€Ÿè¨˜å¸³</h3>
            
            <div className="space-y-3">
              <div className="grid grid-cols-2 gap-3">
                <select value={newExpense.date} onChange={e => setNewExpense({...newExpense, date: e.target.value})} className="w-full bg-gray-100 rounded-xl p-3 font-hand outline-none">
                  {itinerary.map(d => <option key={d.id} value={d.date}>{d.date} ({d.weekday})</option>)}
                </select>
                <select value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value})} className="w-full bg-gray-100 rounded-xl p-3 font-hand outline-none">
                  {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
              </div>
              
              <input 
                placeholder="è²·äº†ä»€éº¼ï¼ŸğŸ¦€" 
                value={newExpense.item} 
                onChange={e => setNewExpense({...newExpense, item: e.target.value})} 
                className="w-full text-lg font-bold border-b-2 border-dashed border-gray-300 focus:border-[#FF9F43] outline-none py-2 font-hand" 
              />
              
              <div className="flex gap-2">
                <input 
                  type="number" 
                  placeholder="é‡‘é¡" 
                  value={newExpense.amount} 
                  onChange={e => setNewExpense({...newExpense, amount: e.target.value})} 
                  className="flex-1 bg-gray-100 rounded-xl p-3 font-hand font-bold text-xl outline-none" 
                />
                <div className="flex gap-1 bg-gray-100 rounded-xl p-1">
                  <button onClick={() => setNewExpense({...newExpense, currency: 'JPY'})} className={`px-4 rounded-lg font-bold font-hand transition-all ${newExpense.currency === 'JPY' ? 'bg-[#FF9F43] text-white' : 'text-gray-400'}`}>Â¥</button>
                  <button onClick={() => setNewExpense({...newExpense, currency: 'TWD'})} className={`px-4 rounded-lg font-bold font-hand transition-all ${newExpense.currency === 'TWD' ? 'bg-[#FF9F43] text-white' : 'text-gray-400'}`}>$</button>
                </div>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <select value={newExpense.method} onChange={e => setNewExpense({...newExpense, method: e.target.value})} className="w-full text-sm bg-gray-100 rounded-xl p-3 font-hand">
                  {PAYMENT_METHODS.map(m => <option key={m} value={m}>{m}</option>)}
                </select>
                <select value={newExpense.platform} onChange={e => setNewExpense({...newExpense, platform: e.target.value})} className="w-full text-sm bg-gray-100 rounded-xl p-3 font-hand">
                  {BOOKING_PLATFORMS.map(p => <option key={p} value={p}>{p}</option>)}
                </select>
              </div>
              
              <input 
                placeholder="å‚™è¨» (é¸å¡«)" 
                value={newExpense.note} 
                onChange={e => setNewExpense({...newExpense, note: e.target.value})} 
                className="w-full bg-gray-50 rounded-xl p-3 font-hand outline-none" 
              />
              
              <button onClick={handleAddExpense} className="w-full bg-[#FF9F43] text-white font-hand font-bold text-xl py-3 rounded-xl korean-3d-btn border-2 border-black flex justify-center items-center gap-2">
                <Icons.Plus size={20} /> è¨˜ä¸€ç­†
              </button>
            </div>
          </div>
        </div>
      );

      // åŒ¯å‡ºé¸é … Modal
      const ExportModal = () => (
        <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowExportModal(false)}>
          <div className="bg-white w-11/12 max-w-sm rounded-2xl p-5 fade-in" onClick={e => e.stopPropagation()}>
            <h3 className="font-hand font-bold text-xl text-gray-800 mb-4 text-center">ğŸ“Š åŒ¯å‡ºè³‡æ–™</h3>
            
            <div className="space-y-3">
              <button onClick={exportToExcel} className="w-full bg-[#207245] text-white font-hand font-bold py-3 rounded-xl korean-3d-btn border-2 border-black flex justify-center items-center gap-2">
                <Icons.FileSpreadsheet size={20} /> åŒ¯å‡º Excel (.xlsx)
              </button>
              
              <div className="bg-gray-50 rounded-xl p-3 text-sm font-hand text-gray-600">
                <p className="font-bold mb-1">ğŸ“‹ åŒ¯å‡ºå…§å®¹åŒ…å«ï¼š</p>
                <ul className="list-disc list-inside space-y-1">
                  <li>è¡Œç¨‹ç¸½è¦½</li>
                  <li>æ¯æ—¥è¨˜å¸³æ˜ç´°</li>
                  <li>è³¼ç‰©æ¸…å–®</li>
                  <li>èŠ±è²»çµ±è¨ˆ</li>
                  <li>å„æ—¥ç¨ç«‹åˆ†é </li>
                </ul>
              </div>
            </div>
            
            <button onClick={() => setShowExportModal(false)} className="w-full mt-4 text-gray-400 font-hand">å–æ¶ˆ</button>
          </div>
        </div>
      );

      return (
        <div className="flex flex-col h-full bg-white max-w-md mx-auto shadow-2xl overflow-hidden relative">
          
          {/* æ¯æ—¥è¡Œç¨‹ç¨ç«‹é é¢ */}
          {selectedDay && <DayDetailPage day={selectedDay} onClose={() => setSelectedDay(null)} />}
          
          {/* å¿«é€Ÿè¨˜å¸³ Modal */}
          {showExpenseModal && <ExpenseModal />}
          
          {/* åŒ¯å‡º Modal */}
          {showExportModal && <ExportModal />}
          
          {/* Status Bar Spacer */}
          <div className="safe-area-top"></div>

          {/* Header */}
          <div className="bg-[#FF6B6B] p-5 relative overflow-hidden border-b-4 border-black shrink-0">
            <div className="absolute top-[-20px] right-[-20px] w-24 h-24 bg-[#FF8787] rounded-full opacity-50 blur-xl"></div>
            <div className="absolute bottom-[-10px] left-[-10px] w-16 h-16 bg-[#FFA5A5] rounded-full opacity-60"></div>
            <h1 className="font-hand text-3xl font-black text-white tracking-wider flex items-center gap-2 relative z-10 drop-shadow-md">
              <span className="text-4xl">ğŸ¦€</span> 2026é—œè¥¿<br/>èƒèŸ¹æ©«è‘—èµ°
            </h1>
            <div className="flex justify-between mt-3 font-hand text-lg font-bold text-gray-800 bg-white/90 p-2 rounded-xl backdrop-blur-sm shadow-lg transform -rotate-1">
              <div className="text-[#FF6B6B]">Â¥{totalSpentJPY.toLocaleString()}</div>
              <div className="w-[2px] bg-gray-200"></div>
              <div className="text-[#4ECDC4]">${totalSpentTWD.toLocaleString()}</div>
            </div>
          </div>

          {/* Scrollable Content */}
          <div className="flex-1 overflow-y-auto p-4 paper-texture no-scrollbar pb-24 relative">
            
            {/* Itinerary Tab */}
            {activeTab === 'itinerary' && (
              <div className="space-y-4 fade-in">
                {/* å¿«é€Ÿæ—¥æœŸé¸æ“‡ */}
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                  {itinerary.map((day, index) => (
                    <button 
                      key={day.id}
                      onClick={() => setSelectedDay(day)}
                      className="shrink-0 px-4 py-2 rounded-full font-hand font-bold text-white text-sm korean-3d-btn"
                      style={{ backgroundColor: BUTTON_COLORS[index % BUTTON_COLORS.length] }}
                    >
                      {day.date}
                    </button>
                  ))}
                </div>
                
                {/* è¡Œç¨‹åˆ—è¡¨ */}
                {itinerary.map((day, index) => {
                  const isExpanded = expandedDayId === day.id;
                  const btnColor = BUTTON_COLORS[index % BUTTON_COLORS.length];
                  const dayExpenses = getExpensesByDate(day.date);
                  const dayTotal = dayExpenses.filter(e => e.currency === 'JPY').reduce((a, b) => a + b.amount, 0);
                  
                  return (
                    <div key={day.id} className="transition-all duration-300">
                      <button onClick={() => toggleDay(day.id)} className={`w-full korean-3d-btn rounded-xl border-2 border-black p-4 flex items-center justify-between ${isExpanded ? 'translate-y-[4px] shadow-none bg-gray-100' : 'bg-white'}`}>
                        <div className="flex items-center gap-3 text-left overflow-hidden">
                          <div className="w-12 h-12 shrink-0 rounded-full flex flex-col items-center justify-center text-white font-bold font-hand text-xs border-2 border-black shadow-sm" style={{ backgroundColor: btnColor }}>
                            <span className="text-sm">{day.date}</span>
                            <span className="text-[10px] opacity-80">{day.weekday}</span>
                          </div>
                          <div className="flex flex-col overflow-hidden">
                            <span className="font-hand font-bold text-lg text-gray-800 truncate w-40">{day.content.split('â†’')[0]}...</span>
                            <span className="font-hand text-xs text-gray-500 truncate">ğŸ  {day.stay || 'æœªå®šä½å®¿'}</span>
                            {dayTotal > 0 && <span className="font-hand text-xs text-[#FF9F43]">ğŸ’° Â¥{dayTotal.toLocaleString()}</span>}
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <button 
                            onClick={(e) => { e.stopPropagation(); setSelectedDay(day); }}
                            className="text-gray-400 hover:text-[#4ECDC4] p-1"
                          >
                            <Icons.ChevronRight size={20} />
                          </button>
                          <div className="text-gray-400">{isExpanded ? <Icons.ChevronUp /> : <Icons.ChevronDown />}</div>
                        </div>
                      </button>
                      {isExpanded && (
                        <div className="mt-2 bg-white/60 border-2 border-dashed border-gray-300 rounded-xl p-3 fade-in">
                          <textarea className="w-full font-hand text-lg text-gray-700 bg-white border-2 border-gray-200 rounded-lg p-2 focus:border-[#4ECDC4] outline-none" rows={3} value={day.content} onChange={(e) => updateItinerary(day.id, 'content', e.target.value)} />
                          <div className="mt-2 grid gap-2">
                            <div className="flex items-center gap-2 bg-blue-50 p-2 rounded-lg border border-blue-100">
                              <Icons.Train size={16} className="text-blue-500" />
                              <input value={day.transport} onChange={(e) => updateItinerary(day.id, 'transport', e.target.value)} className="bg-transparent w-full font-hand text-sm outline-none" placeholder="äº¤é€š"/>
                            </div>
                            <div className="flex items-center gap-2 bg-purple-50 p-2 rounded-lg border border-purple-100">
                              <Icons.Home size={16} className="text-purple-500" />
                              <input value={day.stay} onChange={(e) => updateItinerary(day.id, 'stay', e.target.value)} className="bg-transparent w-full font-hand text-sm outline-none" placeholder="ä½å®¿"/>
                            </div>
                          </div>
                          <button 
                            onClick={() => setSelectedDay(day)}
                            className="w-full mt-3 bg-[#4ECDC4] text-white font-hand font-bold py-2 rounded-lg flex items-center justify-center gap-2"
                          >
                            <Icons.Calendar size={16} /> æŸ¥çœ‹å®Œæ•´é é¢
                          </button>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}

            {/* Expenses Tab */}
            {activeTab === 'expenses' && (
              <div className="space-y-4 fade-in">
                {/* çµ±è¨ˆå¡ç‰‡ */}
                <div className="bg-white p-4 rounded-2xl shadow-lg border-2 border-gray-100">
                  <div className="grid grid-cols-3 gap-3 text-center">
                    <div>
                      <div className="text-2xl font-black font-hand text-[#FF6B6B]">Â¥{totalSpentJPY.toLocaleString()}</div>
                      <div className="text-xs text-gray-400 font-hand">æ—¥å¹£èŠ±è²»</div>
                    </div>
                    <div>
                      <div className="text-2xl font-black font-hand text-[#4ECDC4]">${totalSpentTWD.toLocaleString()}</div>
                      <div className="text-xs text-gray-400 font-hand">å°å¹£èŠ±è²»</div>
                    </div>
                    <div>
                      <div className="text-2xl font-black font-hand text-gray-600">{expenses.length}</div>
                      <div className="text-xs text-gray-400 font-hand">ç­†è¨˜éŒ„</div>
                    </div>
                  </div>
                </div>
                
                {/* æ—¥æœŸç¯©é¸ */}
                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                  <button 
                    onClick={() => setExpenseFilter('all')}
                    className={`shrink-0 px-4 py-2 rounded-full font-hand font-bold text-sm transition-all ${expenseFilter === 'all' ? 'bg-[#FF9F43] text-white' : 'bg-white text-gray-500 border border-gray-200'}`}
                  >
                    å…¨éƒ¨
                  </button>
                  {itinerary.map((day) => (
                    <button 
                      key={day.id}
                      onClick={() => setExpenseFilter(day.date)}
                      className={`shrink-0 px-4 py-2 rounded-full font-hand font-bold text-sm transition-all ${expenseFilter === day.date ? 'bg-[#FF9F43] text-white' : 'bg-white text-gray-500 border border-gray-200'}`}
                    >
                      {day.date}
                    </button>
                  ))}
                </div>
                
                {/* è¨˜å¸³åˆ—è¡¨ */}
                <div className="space-y-2 pb-10">
                  {filteredExpenses.length > 0 ? (
                    filteredExpenses.slice().reverse().map(expense => (
                      <div key={expense.id} className="bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center">
                        <div>
                          <span className="text-xs text-gray-400 font-hand font-bold">{expense.date} â€¢ {expense.category}</span>
                          <div className="text-lg font-bold font-hand text-gray-800">{expense.item}</div>
                          <div className="flex gap-2 mt-1">
                            <span className="text-[10px] bg-gray-100 px-1.5 rounded text-gray-500">{expense.method}</span>
                            {expense.note && <span className="text-[10px] bg-blue-50 px-1.5 rounded text-blue-500">{expense.note}</span>}
                          </div>
                        </div>
                        <div className="flex flex-col items-end">
                          <span className="text-xl font-black font-hand text-[#FF9F43]">{expense.currency === 'JPY' ? 'Â¥' : '$'}{expense.amount.toLocaleString()}</span>
                          <button onClick={() => handleDeleteExpense(expense.id)} className="text-gray-300 hover:text-red-400 mt-1"><Icons.Trash2 size={14} /></button>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="text-center py-10">
                      <div className="text-6xl mb-3">ğŸ“</div>
                      <p className="font-hand text-gray-400">é‚„æ²’æœ‰è¨˜å¸³ç´€éŒ„</p>
                      <p className="font-hand text-gray-300 text-sm">é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹è¨˜å¸³ï¼</p>
                    </div>
                  )}
                </div>
                
                {/* æµ®å‹•è¨˜å¸³æŒ‰éˆ• */}
                <button 
                  onClick={() => setShowExpenseModal(true)}
                  className="fixed bottom-28 right-6 w-14 h-14 bg-[#FF9F43] text-white rounded-full shadow-lg korean-3d-btn border-2 border-black flex items-center justify-center"
                >
                  <Icons.Plus size={28} />
                </button>
              </div>
            )}

            {/* Shopping Tab */}
            {activeTab === 'shopping' && (
              <div className="space-y-4 fade-in">
                {/* é€²åº¦æ¢ */}
                <div className="bg-white p-4 rounded-2xl shadow-lg border-2 border-gray-100">
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-hand font-bold text-gray-700">è³¼ç‰©é€²åº¦</span>
                    <span className="font-hand font-bold text-[#FF6B81]">{shoppingProgress}%</span>
                  </div>
                  <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                    <div className="h-full bg-gradient-to-r from-[#FF6B81] to-[#FF9F9F] progress-bar rounded-full" style={{ width: `${shoppingProgress}%` }}></div>
                  </div>
                  <div className="text-xs text-gray-400 font-hand mt-1">
                    {shoppingList.filter(i => i.bought).length} / {shoppingList.length} é …å®Œæˆ
                  </div>
                </div>
                
                {/* æ–°å¢é …ç›® */}
                <div className="bg-white p-4 rounded-2xl shadow-lg border-2 border-gray-100">
                  <div className="flex gap-2 mb-3">
                    <input 
                      placeholder="æƒ³è²·ä»€éº¼..." 
                      value={newShopItem.item} 
                      onChange={e => setNewShopItem({...newShopItem, item: e.target.value})} 
                      className="flex-1 bg-gray-100 rounded-xl px-4 py-2 font-hand text-lg focus:bg-white focus:ring-2 focus:ring-[#FF6B81] outline-none" 
                    />
                  </div>
                  <div className="grid grid-cols-3 gap-2 mb-3">
                    <input 
                      type="number"
                      placeholder="é ç®— Â¥" 
                      value={newShopItem.budget} 
                      onChange={e => setNewShopItem({...newShopItem, budget: e.target.value})} 
                      className="bg-gray-100 rounded-xl px-3 py-2 font-hand text-sm outline-none" 
                    />
                    <input 
                      placeholder="å•†åº—" 
                      value={newShopItem.store} 
                      onChange={e => setNewShopItem({...newShopItem, store: e.target.value})} 
                      className="bg-gray-100 rounded-xl px-3 py-2 font-hand text-sm outline-none" 
                    />
                    <select 
                      value={newShopItem.priority} 
                      onChange={e => setNewShopItem({...newShopItem, priority: e.target.value})} 
                      className="bg-gray-100 rounded-xl px-2 py-2 font-hand text-sm outline-none"
                    >
                      <option value="high">ğŸ”´ å¿…è²·</option>
                      <option value="medium">ğŸŸ¡ æƒ³è²·</option>
                      <option value="low">ğŸŸ¢ çœ‹çœ‹</option>
                    </select>
                  </div>
                  <button onClick={handleAddShoppingItem} className="w-full bg-[#FF6B81] text-white p-3 rounded-xl border-2 border-black korean-3d-btn font-hand font-bold flex items-center justify-center gap-2">
                    <Icons.Plus size={20}/> åŠ å…¥æ¸…å–®
                  </button>
                </div>
                
                {/* è³¼ç‰©æ¸…å–® */}
                <div className="space-y-3 pb-20">
                  {/* æœªè³¼è²· */}
                  {shoppingList.filter(item => !item.bought).sort((a, b) => {
                    const order = { high: 0, medium: 1, low: 2 };
                    return order[a.priority] - order[b.priority];
                  }).map(item => (
                    <div 
                      key={item.id} 
                      className="bg-white p-4 rounded-xl border-2 cursor-pointer transition-all relative font-hand shadow-md"
                      style={{ borderColor: PRIORITY_COLORS[item.priority] }}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3" onClick={() => toggleShoppingItem(item.id)}>
                          <div 
                            className="w-7 h-7 rounded-full border-2 flex items-center justify-center"
                            style={{ borderColor: PRIORITY_COLORS[item.priority] }}
                          ></div>
                          <div>
                            <div className="font-bold text-lg text-gray-700">{item.item}</div>
                            <div className="text-xs text-gray-400 flex gap-2">
                              {item.budget > 0 && <span>Â¥{item.budget.toLocaleString()}</span>}
                              {item.store && <span>ğŸ“ {item.store}</span>}
                            </div>
                          </div>
                        </div>
                        <button onClick={() => deleteShoppingItem(item.id)} className="text-gray-300 hover:text-red-400">
                          <Icons.Trash2 size={18} />
                        </button>
                      </div>
                    </div>
                  ))}
                  
                  {/* å·²è³¼è²· */}
                  {shoppingList.filter(item => item.bought).length > 0 && (
                    <div className="pt-4">
                      <h3 className="font-hand font-bold text-gray-400 mb-2">âœ“ å·²è³¼è²·</h3>
                      {shoppingList.filter(item => item.bought).map(item => (
                        <div 
                          key={item.id} 
                          onClick={() => toggleShoppingItem(item.id)}
                          className="bg-gray-100 p-3 rounded-xl cursor-pointer transition-all mb-2 opacity-60"
                        >
                          <div className="flex items-center gap-3">
                            <div className="w-6 h-6 rounded-full bg-gray-400 flex items-center justify-center check-bounce">
                              <Icons.Check size={14} className="text-white" />
                            </div>
                            <span className="font-hand text-gray-500 line-through">{item.item}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                
                {/* åŒ¯å‡ºæŒ‰éˆ• */}
                <div className="fixed bottom-28 left-1/2 transform -translate-x-1/2">
                  <button onClick={() => setShowExportModal(true)} className="bg-[#207245] text-white px-6 py-3 rounded-full font-hand font-bold text-lg shadow-lg flex items-center gap-2">
                    <Icons.Download size={20} /> åŒ¯å‡º Excel
                  </button>
                </div>
              </div>
            )}
          </div>

          {/* Bottom Nav */}
          <div className="bg-white p-3 border-t-2 border-gray-100 flex justify-between items-end pb-8 z-20 shrink-0 safe-area-bottom">
            <TabButton id="itinerary" IconComp={Icons.Map} label="è¡Œç¨‹" color="#4ECDC4" />
            <TabButton id="expenses" IconComp={Icons.Coins} label="è¨˜å¸³" color="#FF9F43" />
            <TabButton id="shopping" IconComp={Icons.ShoppingBag} label="è³¼ç‰©" color="#FF6B81" />
          </div>

        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
  
  <!-- Service Worker Registration for PWA -->
  <script>
    // Register Service Worker for offline capability
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        // Create a simple service worker inline
        const swContent = `
          const CACHE_NAME = 'crab-travel-v1';
          const urlsToCache = ['/'];
          
          self.addEventListener('install', event => {
            self.skipWaiting();
          });
          
          self.addEventListener('fetch', event => {
            event.respondWith(
              fetch(event.request).catch(() => caches.match(event.request))
            );
          });
        `;
        
        const blob = new Blob([swContent], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        // For local file usage, we'll skip SW registration
        // navigator.serviceWorker.register(swUrl);
      });
    }
    
    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });
  </script>
</body>
</html>
