<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>åŒ—æµ·é“&æ±äº¬ä¹‹æ—…</title>
    <style>
        /* CSS æ¨£å¼ï¼šè®“ç¶²é çœ‹èµ·ä¾†åƒ App */
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text: #000000;
            --danger: #FF3B30;
            --success: #34C759;
            --warning: #FF9500;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            padding-bottom: 80px; /* é¿é–‹åº•éƒ¨å°èˆª */
            -webkit-tap-highlight-color: transparent;
        }
        header {
            background-color: var(--card-bg);
            padding: 15px 20px;
            padding-top: max(15px, env(safe-area-inset-top));
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 { margin: 0; font-size: 20px; font-weight: 700; }
        
        /* é é¢åˆ‡æ› */
        .view { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡è¨­è¨ˆ */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .day-date { font-weight: bold; font-size: 18px; color: var(--primary); }
        .day-title { font-size: 16px; font-weight: 600; margin-bottom: 5px; }
        .info-row { display: flex; margin-top: 5px; font-size: 14px; color: #666; }
        .info-icon { margin-right: 6px; width: 20px; text-align: center; }

        /* è¨˜å¸³è¡¨å–® */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 14px; color: #555; }
        input, select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px;
            font-size: 16px; background: #fff; box-sizing: border-box;
        }
        .btn {
            background: var(--primary); color: white; border: none; padding: 14px;
            width: 100%; border-radius: 12px; font-size: 16px; font-weight: bold;
            cursor: pointer; text-align: center;
        }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }

        /* åº•éƒ¨å°èˆª */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #ccc;
            display: flex; justify-content: space-around;
            padding: 10px 0; padding-bottom: max(10px, env(safe-area-inset-bottom));
        }
        .tab-item { text-align: center; color: #999; font-size: 10px; flex: 1; cursor: pointer; }
        .tab-item.active { color: var(--primary); }
        .tab-icon { font-size: 24px; display: block; margin-bottom: 2px; }

        /* è³¼ç‰©æ¸…å–® */
        .shop-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .shop-item input[type="checkbox"] { width: 24px; height: 24px; margin-right: 10px; }
        .checked { text-decoration: line-through; color: #aaa; }

        /* çµ±è¨ˆ */
        .stat-box { text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px; margin-bottom: 10px; }
        .big-number { font-size: 32px; font-weight: bold; color: var(--text); }
        .sub-text { font-size: 14px; color: #666; }

        /* æç¤ºæ¡† */
        .tip-box { background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; font-size: 13px; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<header>
    <h1 id="page-title">ğŸ“… è¡Œç¨‹ç¸½è¦½</h1>
    <div style="font-size:12px; color:#666;" id="rate-display">åŒ¯ç‡: 0.22</div>
</header>

<div id="view-itinerary" class="view active">
    <div id="itinerary-list"></div>
</div>

<div id="view-wallet" class="view">
    <div class="card">
        <h3>ğŸ’¸ æ–°å¢æ”¯å‡º</h3>
        <div class="form-group">
            <label>æ¶ˆè²»é …ç›®</label>
            <input type="text" id="expense-name" placeholder="ä¾‹å¦‚ï¼šä¸€å¹»æ‹‰éºµ">
        </div>
        <div class="form-group" style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>é‡‘é¡</label>
                <input type="number" id="expense-amount" placeholder="0">
            </div>
            <div style="width: 80px;">
                <label>å¹£åˆ¥</label>
                <select id="expense-currency" onchange="calcPreview()">
                    <option value="JPY">JPY</option>
                    <option value="TWD">TWD</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>æ”¯ä»˜æ–¹å¼</label>
            <select id="expense-method" onchange="showCardTip()">
                <option value="ç¾é‡‘">ğŸ’° ç¾é‡‘ (JPY)</option>
                <option value="è¥¿ç“œå¡">ğŸ§ è¥¿ç“œå¡/ICOCA</option>
                <option value="ApplePay">ğŸ Apple Pay</option>
                <option value="ä¸­ä¿¡ANA">ğŸ’³ ä¸­ä¿¡ ANA è¯åå¡</option>
                <option value="ç‰å±±ä¸–ç•Œ">ğŸ’³ ç‰å±±ä¸–ç•Œå¡</option>
                <option value="åœ‹æ³°CUBE">ğŸ’³ åœ‹æ³° CUBE å¡</option>
            </select>
            <div id="card-tip" class="tip-box"></div>
        </div>
        <div class="form-group">
            <div style="text-align:right; font-size:14px; color:#666;">
                ç´„åˆå°å¹£ï¼š<span id="twd-preview" style="font-weight:bold; color:var(--primary);">$0</span>
            </div>
        </div>
        <button class="btn" onclick="addExpense()">è¨˜ä¸‹ä¸€ç­†</button>
    </div>

    <div class="card">
        <h3>ğŸ“Š æ¶ˆè²»ç´€éŒ„</h3>
        <div id="expense-list"></div>
        <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
            <strong>ç¸½æ”¯å‡º (TWD): </strong> <span id="total-spent" style="color:var(--danger);">$0</span>
        </div>
    </div>
</div>

<div id="view-shopping" class="view">
    <div class="card">
        <div style="display:flex; gap:10px;">
            <input type="text" id="shop-input" placeholder="æƒ³è²·ä»€éº¼ï¼Ÿ">
            <button class="btn" style="width:auto;" onclick="addShopItem()">â•</button>
        </div>
    </div>
    <div class="card">
        <h3>ğŸ›’ å¾…è²·æ¸…å–®</h3>
        <div id="shopping-list"></div>
    </div>
</div>

<div id="view-settings" class="view">
    <div class="card">
        <h3>âš™ï¸ è¨­å®š</h3>
        <div class="form-group">
            <label>ç›®å‰æ—¥å¹£åŒ¯ç‡</label>
            <input type="number" id="setting-rate" value="0.22" step="0.001" onchange="updateRate()">
        </div>
        <button class="btn btn-danger" onclick="clearData()">âš ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
    </div>
    <div class="card">
        <h3>â„¹ï¸ æ‚¨çš„å¡ç‰‡æ”»ç•¥</h3>
        <p><strong>ğŸ’³ ä¸­ä¿¡ ANAï¼š</strong>åˆ·æ©Ÿç¥¨ã€æµ·å¤–å¯¦é«”æ¶ˆè²» (ç´¯ç©å“©ç¨‹)</p>
        <p><strong>ğŸ’³ ç‰å±±ä¸–ç•Œï¼š</strong>åˆ·å¤§é¡é£¯åº—ä½å®¿ (é ‚ç´šå¡æ¬Šç›Š)</p>
        <p><strong>ğŸ’³ åœ‹æ³° CUBEï¼š</strong>åƒå–ç©æ¨‚ï¼Œè¨˜å¾—åˆ‡æ›ã€Œæ—¥æœ¬è³ã€(3%å›é¥‹)</p>
    </div>
</div>

<div class="tab-bar">
    <div class="tab-item active" onclick="switchTab('itinerary', this)">
        <span class="tab-icon">ğŸ“…</span>è¡Œç¨‹
    </div>
    <div class="tab-item" onclick="switchTab('wallet', this)">
        <span class="tab-icon">ğŸ’°</span>è¨˜å¸³
    </div>
    <div class="tab-item" onclick="switchTab('shopping', this)">
        <span class="tab-icon">ğŸ›’</span>è³¼ç‰©
    </div>
    <div class="tab-item" onclick="switchTab('settings', this)">
        <span class="tab-icon">âš™ï¸</span>è¨­å®š
    </div>
</div>

<script>
    // --- 1. è³‡æ–™åº« (å¾æ‚¨çš„åœ–ç‰‡èˆ‡éœ€æ±‚æ•´ç†) ---
    const itineraryData = [
        { date: "8/13", w: "ä¸‰", title: "å‡ºç™¼ï¼šå°åŒ— âœˆï¸ æœ­å¹Œ", trans: "é•·æ¦®èˆªç©º (å“©ç¨‹ç¥¨)", stay: "æœ­å¹Œæ±æ©«åŒ—å£ (ç¾å ´ä»˜)", note: "10:10 TPE -> 15:00 CTS" },
        { date: "8/14", w: "å››", title: "ç§»å‹•ï¼šæœ­å¹Œ âœˆï¸ ç¨šå…§", trans: "ANA åœ‹å…§ç·š", stay: "ç¨šå…§ ANA (æ¨‚å¤©åˆ·å¡)", note: "åŒ—å¤§æˆ–åŒ—å»£å³¶Outlet" },
        { date: "8/15", w: "äº”", title: "åˆ©å°»å³¶ä¸€æ—¥éŠ", trans: "æ¸¡è¼ª+å·´å£«", stay: "Dormy Inn (å·²ä»˜)", note: "KLOOK: 3936å…ƒ" },
        { date: "8/16", w: "å…­", title: "ç¨šå…§ä¸€æ—¥éŠ", trans: "æ¸¡è¼ª+å·´å£«", stay: "Dormy Inn (å·²ä»˜)", note: "KLOOK: 3924å…ƒ (å«æ—©)" },
        { date: "8/17", w: "æ—¥", title: "å¤§ç§»å‹•ï¼šç¨šå…§ ğŸš† æœ­å¹Œ", trans: "JRç‰¹æ€¥å®—è°·", stay: "æœ­å¹Œæ±æ€¥REI (JALAN)", note: "13:00ç¨šå…§ -> 20:00æœ­å¹Œ" },
        { date: "8/18", w: "ä¸€", title: "æœ­å¹Œå¸‚å€è§€å…‰", trans: "å¸‚é›»ä¸€æ—¥åˆ¸", stay: "æœ­å¹Œæ±æ€¥REI (JALAN)", note: "ç™½è‰²æˆ€äººã€ä¸­å³¶å…¬åœ’ã€ä¸€å¹»æ‹‰éºµ" },
        { date: "8/19", w: "äºŒ", title: "æœ­å¹Œæ¼«éŠ", trans: "JR", stay: "æœ­å¹Œæ±æ€¥REI (JALAN)", note: "æ—©é¤æµ·è†½é£¯ã€åŒ—æµ·é“ç¥å®®" },
        { date: "8/20", w: "ä¸‰", title: "ç§»å‹•ï¼šæœ­å¹Œ âœˆï¸ æ±äº¬", trans: "ANA åœ‹å…§ç·š", stay: "æ±æ­¦æ·ºè‰ç«™å‰ (JALAN)", note: "12:30 CTS -> 14:10 HND" },
        { date: "8/21", w: "å››", title: "æ—¥å…‰ 2æ—¥éŠ (Day1)", trans: "æ±æ­¦æ—¥å…‰ç¥¨(1063å…ƒ)", stay: "æ—¥å…‰ æ˜Ÿä¹‹å®¿ (æ¨‚å¤©)", note: "" },
        { date: "8/22", w: "äº”", title: "æ—¥å…‰ 2æ—¥éŠ (Day2)", trans: "æ±æ­¦æ—¥å…‰ç¥¨(397å…ƒ)", stay: "æ±äº¬è»Šç«™æ±æ©« (å®˜ç¶²)", note: "å›æ±äº¬" },
        { date: "8/23", w: "å…­", title: "æ±äº¬å¸‚å€ä¸€æ—¥éŠ", trans: "åœ°éµ/JR", stay: "æ±äº¬è»Šç«™æ±æ©« (JALAN)", note: "" },
        { date: "8/24", w: "æ—¥", title: "è¿”å®¶ï¼šæˆç”° âœˆï¸ é«˜é›„", trans: "è¯èˆª", stay: "æº«æš–çš„å®¶", note: "é‡‘å­åŠä¹‹åŠ©, 12:40 NRT -> 15:05 KHH" }
    ];

    // å…¨åŸŸè®Šæ•¸
    let expenses = JSON.parse(localStorage.getItem('myTripExpenses')) || [];
    let shopList = JSON.parse(localStorage.getItem('myTripShopList')) || [];
    let exchangeRate = parseFloat(localStorage.getItem('myTripRate')) || 0.22;

    // --- 2. åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        renderItinerary();
        renderExpenses();
        renderShopList();
        document.getElementById('setting-rate').value = exchangeRate;
        updateRateDisplay();
    });

    // --- 3. é é¢åˆ‡æ›é‚è¼¯ ---
    function switchTab(viewId, element) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');
        
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        const titles = { 'itinerary': 'ğŸ“… è¡Œç¨‹ç¸½è¦½', 'wallet': 'ğŸ’° æ—…éŠè¨˜å¸³', 'shopping': 'ğŸ›’ è³¼ç‰©æ¸…å–®', 'settings': 'âš™ï¸ è¨­å®š' };
        document.getElementById('page-title').innerText = titles[viewId];
    }

    // --- 4. è¡Œç¨‹åŠŸèƒ½ ---
    function renderItinerary() {
        const container = document.getElementById('itinerary-list');
        container.innerHTML = itineraryData.map(item => `
            <div class="card">
                <div class="day-header">
                    <span class="day-date">${item.date} (${item.w})</span>
                </div>
                <div class="day-title">${item.title}</div>
                <div class="info-row"><span class="info-icon">ğŸš†</span> ${item.trans}</div>
                <div class="info-row"><span class="info-icon">ğŸ¨</span> ${item.stay}</div>
                ${item.note ? `<div class="info-row" style="color:#888; font-style:italic;"><span class="info-icon">ğŸ“</span> ${item.note}</div>` : ''}
            </div>
        `).join('');
    }

    // --- 5. è¨˜å¸³åŠŸèƒ½ ---
    function updateRate() {
        exchangeRate = parseFloat(document.getElementById('setting-rate').value);
        localStorage.setItem('myTripRate', exchangeRate);
        updateRateDisplay();
        calcPreview();
        renderExpenses(); // é‡ç®—ç¸½é¡
    }

    function updateRateDisplay() {
        document.getElementById('rate-display').innerText = `åŒ¯ç‡: ${exchangeRate}`;
    }

    function calcPreview() {
        const amt = parseFloat(document.getElementById('expense-amount').value) || 0;
        const curr = document.getElementById('expense-currency').value;
        const total = (curr === 'JPY') ? Math.round(amt * exchangeRate) : amt;
        document.getElementById('twd-preview').innerText = `$${total}`;
    }

    // å¡ç‰‡æç¤ºé‚è¼¯ (é—œéµï¼)
    function showCardTip() {
        const method = document.getElementById('expense-method').value;
        const tipBox = document.getElementById('card-tip');
        let tipText = "";

        if(method === "ä¸­ä¿¡ANA") tipText = "âœˆï¸ è¨˜å¾—åˆ·é€™å¼µç´¯ç©å“©ç¨‹ï¼";
        else if(method === "ç‰å±±ä¸–ç•Œ") tipText = "ğŸ‘‘ å¤§é¡æ¶ˆè²»å»ºè­°ç”¨æ­¤å¡";
        else if(method === "åœ‹æ³°CUBE") tipText = "âš ï¸ è«‹åˆ‡æ›æ¬Šç›Šè‡³ã€Œæ—¥æœ¬è³ã€(3%)";
        else if(method === "è¥¿ç“œå¡") tipText = "ğŸ§ è¨˜å¾—è¦è¨˜ä¸€ç­†ã€Œå„²å€¼ã€å–”";

        if(tipText) {
            tipBox.style.display = 'block';
            tipBox.innerText = tipText;
        } else {
            tipBox.style.display = 'none';
        }
    }

    function addExpense() {
        const name = document.getElementById('expense-name').value;
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const currency = document.getElementById('expense-currency').value;
        const method = document.getElementById('expense-method').value;

        if(!name || !amount) { alert('è«‹è¼¸å…¥é …ç›®å’Œé‡‘é¡'); return; }

        const twd = (currency === 'JPY') ? Math.round(amount * exchangeRate) : amount;

        const newExp = {
            id: Date.now(),
            date: new Date().toLocaleDateString(),
            name, amount, currency, method, twd
        };

        expenses.unshift(newExp);
        localStorage.setItem('myTripExpenses', JSON.stringify(expenses));
        
        // é‡ç½®è¡¨å–®
        document.getElementById('expense-name').value = '';
        document.getElementById('expense-amount').value = '';
        renderExpenses();
        alert('è¨˜å¸³æˆåŠŸï¼');
    }

    function renderExpenses() {
        const list = document.getElementById('expense-list');
        let totalTWD = 0;

        list.innerHTML = expenses.map(exp => {
            totalTWD += exp.twd;
            return `
                <div style="border-bottom:1px solid #eee; padding:10px 0; display:flex; justify-content:space-between;">
                    <div>
                        <div style="font-weight:600;">${exp.name}</div>
                        <div style="font-size:12px; color:#888;">${exp.method} | ${exp.date}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="color:var(--primary); font-weight:bold;">$${exp.twd}</div>
                        <div style="font-size:12px; color:#aaa;">${exp.amount} ${exp.currency}</div>
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('total-spent').innerText = `$${totalTWD.toLocaleString()}`;
    }

    // --- 6. è³¼ç‰©æ¸…å–®åŠŸèƒ½ ---
    function addShopItem() {
        const input = document.getElementById('shop-input');
        if(!input.value) return;
        
        shopList.push({ txt: input.value, done: false });
        saveShop();
        input.value = '';
        renderShopList();
    }

    function toggleShop(index) {
        shopList[index].done = !shopList[index].done;
        saveShop();
        renderShopList();
    }

    function saveShop() {
        localStorage.setItem('myTripShopList', JSON.stringify(shopList));
    }

    function renderShopList() {
        const container = document.getElementById('shopping-list');
        container.innerHTML = shopList.map((item, idx) => `
            <div class="shop-item">
                <input type="checkbox" ${item.done ? 'checked' : ''} onclick="toggleShop(${idx})">
                <span class="${item.done ? 'checked' : ''}">${item.txt}</span>
                <button onclick="deleteShop(${idx})" style="margin-left:auto; background:none; border:none; color:#ccc;">âœ•</button>
            </div>
        `).join('');
    }

    function deleteShop(index) {
        shopList.splice(index, 1);
        saveShop();
        renderShopList();
    }

    function clearData() {
        if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è¨˜å¸³å’Œè³¼ç‰©è³‡æ–™å—ï¼Ÿ")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>

</body>
</html>
